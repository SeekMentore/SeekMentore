<?xml version="1.0" encoding="UTF-8"?>
<queryMapper namespace="sales-subscriptionpackage">
	<query type="select" id="selectSubscriptionPackage">
		SELECT
			S.*,
			C.NAME AS CUSTOMER_NAME, 
			C.EMAIL_ID AS CUSTOMER_EMAIL, 
			C.CONTACT_NUMBER AS CUSTOMER_CONTACT_NUMBER,
			T.NAME AS TUTOR_NAME, 
			T.EMAIL_ID AS TUTOR_EMAIL, 
			T.CONTACT_NUMBER AS TUTOR_CONTACT_NUMBER, 
			EN.SUBJECT AS ENQUIRY_SUBJECT,  
			EN.GRADE AS ENQUIRY_GRADE, 
			EN.LOCATION_DETAILS AS ENQUIRY_LOCATION, 
			EN.ADDRESS_DETAILS AS ENQUIRY_ADDRESS_DETAILS,
			EN.ADDITIONAL_DETAILS AS ENQUIRY_ADDITIONAL_DETAILS,
			EN.PREFERRED_TEACHING_TYPE AS ENQUIRY_PREFERRED_TEACHING_TYPE, 
			EN.QUOTED_CLIENT_RATE AS ENQUIRY_QUOTED_CLIENT_RATE,
			EN.NEGOTIATED_RATE_WITH_CLIENT AS ENQUIRY_NEGOTIATED_RATE_WITH_CLIENT,
			EN.CLIENT_NEGOTIATION_REMARKS AS ENQUIRY_CLIENT_NEGOTIATION_REMARKS,
			TM.QUOTED_TUTOR_RATE AS TUTOR_MAPPER_QUOTED_TUTOR_RATE,
			TM.NEGOTIATED_RATE_WITH_TUTOR AS TUTOR_MAPPER_NEGOTIATED_RATE_WITH_TUTOR,
			TM.TUTOR_NEGOTIATION_REMARKS AS TUTOR_MAPPER_TUTOR_NEGOTIATION_REMARKS,
			IFNULL((SELECT NAME FROM EMPLOYEE E WHERE E.USER_ID = S.WHO_ACTED), S.WHO_ACTED) AS WHO_ACTED_NAME,
			IFNULL((SELECT NAME FROM EMPLOYEE E WHERE E.USER_ID = S.UPDATED_BY), S.UPDATED_BY) AS UPDATED_BY_NAME 
		FROM SUBSCRIPTION_PACKAGE S
		INNER JOIN DEMO D ON S.DEMO_ID = D.DEMO_TRACKER_ID
		INNER JOIN TUTOR_MAPPER TM ON S.TUTOR_MAPPER_ID = TM.TUTOR_MAPPER_ID
		INNER JOIN ENQUIRY EN ON S.ENQUIRY_ID = EN.ENQUIRY_ID 
		INNER JOIN REGISTERED_TUTOR T ON S.TUTOR_ID = T.TUTOR_ID
		INNER JOIN SUBSCRIBED_CUSTOMER C ON S.CUSTOMER_ID = C.CUSTOMER_ID
	</query>
	<query type="filter" id="subscriptionPackageTutorIdFilter">
		WHERE TUTOR_ID = :tutorId
	</query>
	<query type="filter" id="subscriptionPackageCustomerIdFilter">
		WHERE CUSTOMER_ID = :customerId
	</query>
	<query type="filter" id="subscriptionPackageCurrentPackageAdditionalFilter">
		AND END_DATE_MILLIS IS NULL
	</query>
	<query type="filter" id="subscriptionPackageHistoryPackageAdditionalFilter">
		AND END_DATE_MILLIS IS NOT NULL
	</query>
	<query type="sorter" id="subscriptionPackageExistingSorter">
		ORDER BY CREATED_MILLIS ASC, START_DATE_MILLIS ASC
	</query>
	<query type="insert" id="insertSubscriptionPackage" paramClass="com.model.components.SubscriptionPackage">
		INSERT INTO SUBSCRIPTION_PACKAGE
			(CUSTOMER_ID, TUTOR_ID, ENQUIRY_ID, TUTOR_MAPPER_ID, DEMO_ID, CREATED_MILLIS, RECORD_LAST_UPDATED_MILLIS, UPDATED_BY) 
		VALUES
			(:customerId, :tutorId, :enquiryId, :tutorMapperId, :demoId, :createdMillis, :recordLastUpdatedMillis, :updatedBy)
	</query>
</queryMapper>